

# Техническое задание: Vexor — Платформа тестирования (Telegram Mini App)

## 1. Общие положения

**Платформа:** Telegram Mini App (WebApp)  
**Архитектура:** Feature-Sliced Design (FSD)  
**Стек:** Next.js 14+ (App Router), TypeScript, Drizzle ORM, PostgreSQL  
**Логика:** Server Actions (без API Routes, кроме webhook Telegram)

**Две базы данных:**
- **Основная БД (Vexor):** Пользователи, роли, блоки, опросы, ответы, логи, рейтинги
- **KNOWLEDGE_BASE (внешняя):** Категории рецептов, рецепты (только для EditorPage)

---

## 2. Система ролей и иерархия

### 2.1 Роли (по убыванию прав)

| Роль | Уровень | Может назначать | Может снять |
|------|---------|-----------------|-------------|
| **ROOTKIT** | 3 | ADMIN, MANAGER, USER | ADMIN, MANAGER |
| **ADMINISTRATOR** | 2 | MANAGER, USER | MANAGER → USER |
| **MANAGER** | 1 | USER | — |
| **USER** | 0 | — | — |

### 2.2 Особые правила ROOTKIT

- **Истинный Творец** — Telegram ID из `env.TELEGRAM_BOT_ADMINISTRATOR_ID`
- При любом входе система проверяет: если `telegram_id === env.TELEGRAM_BOT_ADMINISTRATOR_ID` → принудительно выдается роль ROOTKIT
- **Неуязвимость:** ROOTKIT нельзя снизить в правах или удалить (даже другим ROOTKIT)
- ROOTKIT может назначать других ROOTKIT (но только истинный творец неуязвим)
- Снятие роли ROOTKIT возможно только если назначал не истинный творец

---

## 3. Авторизация и профиль

### 3.1 Вход
- Только через Telegram Mini App (WebAppInitData)
- В БД хранится только `telegram_id` + связанные данные профиля
- При первом входе создается запись с role = USER (кроме истинного творца)

### 3.2 Профиль пользователя

**Поля:**
- Имя, фамилия (из Telegram, редактируемы)
- Должность (текст, с фильтром)
- Стаж (текст)
- Роль (системное поле)
- Рейтинговые показатели (score, globalRank)

**Правила редактирования:**

| Поле | Редактирует | Ограничения |
|------|-------------|-------------|
| Имя, фамилия | Сам пользователь, MANAGER+ | — |
| Должность | Сам пользователь, MANAGER+ | Фильтр запрещенных слов* |
| Стаж | MANAGER+ | — |
| Роль | ADMIN+ (по иерархии) | Логирование в audit_logs |

*Фильтр: запрещено "блять", "CTO", "главный директор", "овнер", "owner", "director" и вариации. Исключение: если редактирует MANAGER или выше — фильтр не применяется.

### 3.3 Видимость профиля

**Публичная часть (видна всем):**
- Имя, фамилия
- Должность, стаж
- globalRank (если ≥ 0)
- Статистика (пройдено тестов, средний балл)

**Приватная часть:**
- **Таб "Активность"** — только владелец профиля + MANAGER+
- **Таб "Логи"** — только владелец профиля

### 3.4 Главная страница
- В шапке (aria-label="профиль") отображается имя пользователя из Telegram
- Таблица рейтинга: клик по участнику → переход в его публичный профиль

---

## 4. Рейтинговая система

### 4.1 Начальное состояние
- Новый пользователь: `score = -1`, `globalRank = null`
- При `score = -1` пользователь **не отображается** в рейтинге

### 4.2 Активация в рейтинге
- После первого пройденного теста score пересчитывается (становится ≥ 0)
- Система автоматически пересчитывает globalRank для всех активных пользователей

### 4.3 Топ-7 на главной
- Отображаются только 7 лучших по globalRank
- Система масштабируется автоматически под общее количество участников
- Порог попадания в топ определяется динамически (на основе распределения score)

---

## 5. Система тестирования (Блоки → Опросы)

### 5.1 Структура
```
Категория (Category) — в основной БД
    ↓
Блок (Block) — привязан к категории
    ↓
Опрос (Quiz) — привязан к блоку, содержит вопросы
```

### 5.2 Права доступа

| Действие | Минимальная роль |
|----------|------------------|
| Создание категории | MANAGER |
| Редактирование категории | MANAGER |
| Создание блока | MANAGER |
| Привязка блока к категории | MANAGER |
| Создание опроса | MANAGER |
| Изменение видимости опроса | MANAGER |
| Прохождение опроса | USER (свой или выше) |

### 5.3 Жизненный цикл опроса

**Создание:**
- Опрос создается со статусом `isVisible = true`
- Указывается `timeLimit` (в минутах)

**Начало прохождения:**
- Пользователь открывает опрос → создается запись `user_quiz` (status: IN_PROGRESS, timestamp начала)
- Система фиксирует дедлайн: `deadline = now + timeLimit`

**Завершение (3 сценария):**

1. **Успешная сдача:** Пользователь主动 нажимает "Завершить" до дедлайна → статус COMPLETED, подсчет баллов
2. **Просрочка (фоновая проверка):** При любом действии с опросом система проверяет `now > deadline`. Если да → принудительная сдача с текущими ответами, статус EXPIRED
3. **Просрочка (CRON-проверка):** Фоновый процесс раз в N минут проверяет просроченные опросы и принудительно завершает их

**После завершения:**
- Опрос становится **невидимым** для данного пользователя (даже при прямом переходе по URL проверяется статус в БД)
- При попытке повторного входа — редирект или сообщение "Тест уже пройден"

### 5.4 Штраф за просрочку

Если опрос завершен принудительно (истек дедлайн):
- Баллы за опрос **вычитаются** из общего score пользователя
- Формула: `newScore = currentScore - maxQuizPoints`
- Пример: у пользователя 70 баллов, опрос стоит 17 → становится 53

---

## 6. База знаний (EditorPage)

### 6.1 Источник данных
- **Отдельная БД (KNOWLEDGE_BASE)** — подключение через отдельный клиент Drizzle
- Используется **только в EditorPage** для выбора категорий и продуктов

### 6.2 Схемы KNOWLEDGE_BASE

**categories:**
```typescript
{
  id: serial("id").primaryKey(),
  label: text("label").notNull(),           // Название категории
  free_alcohol: boolean("free_alcohol").notNull(), // Флаг безалкогольной
  category: text("category").notNull(),     // Код категории
  image: text("image").notNull()            // URL изображения
}
```

**recipes:**
```typescript
{
  id: serial("id").primaryKey(),
  title: text("title").notNull(),
  image: text("image").notNull(),
  prep_time: jsonb("prep_time"),            // { hours?: number, minutes?: number }
  cook_time: jsonb("cook_time"),            // { hours?: number, minutes?: number }
  portion: integer("portion"),
  position: jsonb("position"),              // Объединенные how_to_submit и how_to_sell
  description: text("description"),
  category_id: integer("category_id").references(() => categories.id),
  ingredients: jsonb("ingredients"),        // Массив секций с ингредиентами
  cooking_instructions: jsonb("cooking_instructions"),
  profile: jsonb("profile"),                // Сенсорный профиль: acidity, bitterness, sweetness, aroma, taste
  price: integer("price").notNull()
}
```

### 6.3 Интеграция в EditorPage

**UI-компонент KNOWLEDGE_BASE_SELECTOR:**
- Выпадающий список категорий из KNOWLEDGE_BASE.categories
- После выбора категории — список продуктов (recipes) этой категории
- Данные загружаются через Server Action с отдельным клиентом БД

### 6.4 Фильтрация для ИИ-модели (Gemini)

**При формировании контекста для ИИ:**
- **Исключить категории с кодами:** `NON_ALCOHOLIC_COCKTAILS`, `AUTHOR_TEAS`, `COCKTAILS`
- **Исключить все recipes**, где `category_id` соответствует исключенным категориям
- В UI EditorPage отображаются **все категории без ограничений** (фильтр только для ИИ-контекста)

**Логика фильтра:**
```
IF recipe.category.category IN [NON_ALCOHOLIC_COCKTAILS, AUTHOR_TEAS, COCKTAILS] 
THEN исключить из prompt
```

---

## 7. Логирование и аудит

### 7.1 События для логирования
- Изменение роли (кто, кому, с какой на какую)
- Изменение профиля (кто, кому, какое поле, старое/новое значение)
- Назначение/снятие прав

### 7.2 Доступ к логам
- Пользователь видит только логи, связанные с его профилем (вкладка "Логи")
- ADMIN+ видят все логи (через отдельный интерфейс, если требуется)

---

## 8. Экспорт в PDF

- Доступен ролям: MANAGER, ADMINISTRATOR, ROOTKIT
- USER не имеет доступа к экспорту
- Реализация через Server Action (без API Route)

---

## 9. Технические ограничения

### 9.1 Нельзя изменять
- DOM-структура существующих компонентов
- CSS-классы (кроме вынесения повторяющихся наборов в helper-утилиты)
- Визуальный результат верстки

### 9.2 Обязательно
- Вся бизнес-логика — Server Actions (`"use server"`)
- Типизация: строгий TypeScript, любые `any` должны быть обоснованы
- Сборка: `next build` проходит без ошибок
- Архитектура: чистое FSD, без кастомных слоев
- **Две БД:** основная (Vexor) и KNOWLEDGE_BASE (только чтение для EditorPage)

### 9.3 Таймеры и фоновые процессы
- **Запрещено:** setTimeout на сервере, WebSocket-таймеры, "живые" процессы ожидания
- **Разрешено:** фиксация timestamp в БД, проверка при действии пользователя, фоновый CRON для массовых проверок

---

## 10. Терминология

| Термин | Определение |
|--------|-------------|
| Истинный Творец | Telegram ID из env.TELEGRAM_BOT_ADMINISTRATOR_ID, неуязвимый ROOTKIT |
| Активный пользователь | Пользователь со score ≥ 0, видимый в рейтинге |
| Принудительная сдача | Автоматическое завершение опроса по истечении времени |
| Фоновая проверка | Проверка deadline при любом обращении к опросу |
| KNOWLEDGE_BASE | Внешняя БД с категориями и рецептами для EditorPage |

---

## 11. Чек-лист приемки

- [ ] Вход через Telegram работает, истинный творец получает ROOTKIT
- [ ] ROOTKIT не может быть снят, может назначать/снимать ADMIN и MANAGER
- [ ] ADMIN может снимать MANAGER до USER, не может тронуть ROOTKIT
- [ ] MANAGER может редактировать стаж и должность любого, обходит фильтр слов
- [ ] Пользователь не может сохранить запрещенные слова в должности
- [ ] Профиль открывается по клику из рейтинга, показывает публичные данные
- [ ] Таб "Активность" виден только владельцу и MANAGER+
- [ ] Таб "Логи" виден только владельцу
- [ ] Новый пользователь не виден в рейтинге (score = -1)
- [ ] После прохождения теста появляется в рейтинге
- [ ] Топ-7 отображается на главной
- [ ] Опрос скрывается после прохождения (проверка по URL)
- [ ] Просроченный опрос штрафует на полную стоимость
- [ ] Логирование фиксирует все изменения ролей и профилей
- [ ] Экспорт PDF доступен только MANAGER+
- [ ] EditorPage подключается к KNOWLEDGE_BASE, отображает категории и продукты
- [ ] Категории NON_ALCOHOLIC_COCKTAILS, AUTHOR_TEAS, COCKTAILS не попадают в контекст ИИ
- [ ] Сборка проходит без ошибок, типизация строгая
- [ ] Создать SEED скрипт для заполнения бд минимально
-  Результат считается готовым, если визуальное совпадение сохранено, сборка проходит без ошибок, типизация не нарушена и архитектура упрощает дальнейшую поддержку проекта

Визуальный результат, DOM-структуру и CSS-классы менять нельзя.
Допустимо только устранение DRY: вынос повторяющихся наборов классов в helper-утилиты.
 текущий проект приведен к архитектуре FSD
(app / pages / widgets / features / entities / shared) без кастомных слоёв.


